---
import Layout from '../../layouts/Layout.astro';
import RecipeHeader from '../../components/RecipeHeader.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const recipes = await getCollection('recipes');
  return recipes.map((recipe) => ({
    params: { slug: recipe.slug },
    props: { recipe },
  }));
}

const { recipe } = Astro.props;
const { Content } = await recipe.render();
---

<Layout title={`${recipe.data.title} | Mise`}>
  <!-- Recipe Header with breadcrumb, metadata, and tags -->
  <RecipeHeader {recipe} />

  <!-- Recipe Content -->
  <article class="mt-8 bg-white rounded-2xl shadow-soft border border-slate-200/80 overflow-hidden">
    <div class="p-6 sm:p-8 grid md:grid-cols-[1fr_1.5fr] gap-10">
      <!-- Ingredients Column -->
      <div>
        <h3
          class="text-sm font-bold text-slate-900 mb-4 flex items-center gap-2 border-b border-slate-100 pb-3 uppercase tracking-wide"
        >
          <svg
            class="w-4 h-4 text-indigo-500"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
            ></path>
          </svg>
          Ingredients
        </h3>
        {
          recipe.data.ingredients && recipe.data.ingredients.length > 0 ? (
            <ul class="space-y-2.5">
              {recipe.data.ingredients.map((ingredient) => (
                <li class="flex items-start group">
                  <input
                    type="checkbox"
                    class="mt-1 mr-3 h-4 w-4 rounded border-slate-300 text-indigo-500 focus:ring-indigo-500 cursor-pointer shrink-0"
                  />
                  <span class="text-sm text-slate-600 leading-relaxed group-hover:text-slate-800 transition-colors">
                    {ingredient}
                  </span>
                </li>
              ))}
            </ul>
          ) : (
            <p class="text-slate-400 italic text-sm">No ingredients listed.</p>
          )
        }
      </div>

      <!-- Content Column (Description, Directions, Notes, Nutrition) -->
      <div class="prose-refined">
        <Content />

        <!-- PairsWith Section (if available) -->
        {
          recipe.data.pairsWith && recipe.data.pairsWith.length > 0 && (
            <div class="mt-8 pt-6 border-t border-slate-200">
              <h2 class="text-sm font-bold text-slate-900 mb-4 flex items-center gap-2 border-b border-slate-100 pb-3 uppercase tracking-wide">
                <svg
                  class="w-4 h-4 text-indigo-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                  />
                </svg>
                Pairs Well With
              </h2>
              <ul class="space-y-2">
                {recipe.data.pairsWith.map((pairing) => (
                  <li>
                    <a
                      href={`${import.meta.env.BASE_URL}recipes/${pairing}`}
                      class="text-sm text-indigo-600 hover:text-indigo-500 hover:underline font-medium"
                    >
                      {pairing
                        .split('-')
                        .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
                        .join(' ')}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          )
        }
      </div>
    </div>
  </article>
</Layout>

<script>
  // Remove Serving Suggestions sections from markdown content
  // and ensure H2 headings have proper styling
  document.addEventListener('DOMContentLoaded', () => {
    const recipeContent = document.querySelector('.prose-refined');
    if (!recipeContent) return;

    // Remove Serving Suggestions section
    const headings = recipeContent.querySelectorAll('h2');
    headings.forEach((h2) => {
      if (h2.textContent?.trim() === 'Serving Suggestions') {
        // Remove the h2 and all following elements until next h2 or end
        let nextElement = h2.nextElementSibling;
        h2.remove();
        while (nextElement && nextElement.tagName !== 'H2') {
          const toRemove = nextElement;
          nextElement = nextElement.nextElementSibling;
          toRemove.remove();
        }
      }
    });
  });
</script>
