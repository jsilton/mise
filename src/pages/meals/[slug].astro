---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const meals = await getCollection('meals');
  return meals.map((meal) => ({
    params: { slug: meal.slug },
    props: { meal },
  }));
}

const { meal } = Astro.props;
const { Content } = await meal.render();

// Get recipe collection for linking
const recipes = await getCollection('recipes');
const recipeMap = new Map(recipes.map((r) => [r.slug, r]));

// Helper to get recipe details
function getRecipe(slug: string) {
  return recipeMap.get(slug);
}

function getRecipeTitle(slug: string): string {
  const recipe = recipeMap.get(slug);
  return recipe?.data.title || slug;
}

// Template display info
const templateLabels: Record<string, string> = {
  plate: 'Plate',
  bowl: 'Bowl',
  'pasta-night': 'Pasta Night',
  'soup-and-side': 'Soup & Side',
  'one-pot': 'One-Pot',
  grazing: 'Grazing',
};

const templateColors: Record<string, string> = {
  plate: 'bg-rose-100 text-rose-800',
  bowl: 'bg-amber-100 text-amber-800',
  'pasta-night': 'bg-red-100 text-red-800',
  'soup-and-side': 'bg-emerald-100 text-emerald-800',
  'one-pot': 'bg-violet-100 text-violet-800',
  grazing: 'bg-indigo-100 text-indigo-800',
};
---

<Layout title={`${meal.data.title} | Meals | Mise`}>
  <div class="max-w-3xl mx-auto">
    {/* Breadcrumb */}
    <nav class="mb-8">
      <a
        href={`${import.meta.env.BASE_URL}meals`}
        class="inline-flex items-center gap-1.5 text-sm text-slate-500 hover:text-indigo-600 transition-colors"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"
          ></path>
        </svg>
        Back to Meals
      </a>
    </nav>

    {/* Header Card */}
    <header
      class="mb-8 bg-white rounded-2xl border border-slate-200/80 shadow-soft overflow-hidden"
    >
      <div class="p-6 sm:p-8">
        <div class="flex items-start justify-between gap-4 mb-5">
          <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 tracking-tight leading-tight">
            {meal.data.title}
          </h1>
          {
            meal.data.template && (
              <span
                class={`shrink-0 inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold uppercase tracking-wide ${templateColors[meal.data.template] || 'bg-slate-100 text-slate-600'}`}
              >
                {templateLabels[meal.data.template] || meal.data.template}
              </span>
            )
          }
        </div>

        {/* Time Info */}
        {
          (meal.data.totalPrepTime || meal.data.totalCookTime || meal.data.totalActiveTime) && (
            <div class="flex flex-wrap gap-6 text-sm">
              {meal.data.totalActiveTime && (
                <div class="flex items-center gap-2 text-slate-600">
                  <svg
                    class="w-4 h-4 text-indigo-500"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  <span class="text-slate-500">Active:</span>
                  <span class="font-medium text-slate-700">{meal.data.totalActiveTime}</span>
                </div>
              )}
              {meal.data.totalPrepTime && (
                <div class="flex items-center gap-2 text-slate-600">
                  <span class="text-slate-500">Prep:</span>
                  <span class="font-medium text-slate-700">{meal.data.totalPrepTime}</span>
                </div>
              )}
              {meal.data.totalCookTime && (
                <div class="flex items-center gap-2 text-slate-600">
                  <span class="text-slate-500">Cook:</span>
                  <span class="font-medium text-slate-700">{meal.data.totalCookTime}</span>
                </div>
              )}
            </div>
          )
        }
      </div>
    </header>

    {/* Recipe Components */}
    <section class="mb-8">
      <h2 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">
        Recipes in This Meal
      </h2>
      <div
        class="bg-white rounded-xl border border-slate-200/80 shadow-soft divide-y divide-slate-100 overflow-hidden"
      >
        {
          meal.data.main && (
            <a
              href={`${import.meta.env.BASE_URL}recipes/${meal.data.main}`}
              class="flex items-center gap-4 p-4 hover:bg-slate-50 transition-colors group"
            >
              <span class="w-20 flex-shrink-0 text-xs font-semibold text-slate-400 uppercase tracking-wider">
                Main
              </span>
              <span class="flex-1 font-medium text-slate-900 group-hover:text-indigo-600 transition-colors">
                {getRecipeTitle(meal.data.main)}
              </span>
              <svg
                class="w-4 h-4 text-slate-300 group-hover:text-indigo-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                />
              </svg>
            </a>
          )
        }

        {
          meal.data.sides &&
            meal.data.sides.map((side) => (
              <a
                href={`${import.meta.env.BASE_URL}recipes/${side}`}
                class="flex items-center gap-4 p-4 hover:bg-slate-50 transition-colors group"
              >
                <span class="w-20 flex-shrink-0 text-xs font-semibold text-slate-400 uppercase tracking-wider">
                  Side
                </span>
                <span class="flex-1 font-medium text-slate-900 group-hover:text-indigo-600 transition-colors">
                  {getRecipeTitle(side)}
                </span>
                <svg
                  class="w-4 h-4 text-slate-300 group-hover:text-indigo-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>
            ))
        }

        {
          meal.data.base && (
            <a
              href={`${import.meta.env.BASE_URL}recipes/${meal.data.base}`}
              class="flex items-center gap-4 p-4 hover:bg-slate-50 transition-colors group"
            >
              <span class="w-20 flex-shrink-0 text-xs font-semibold text-slate-400 uppercase tracking-wider">
                Base
              </span>
              <span class="flex-1 font-medium text-slate-900 group-hover:text-indigo-600 transition-colors">
                {getRecipeTitle(meal.data.base)}
              </span>
              <svg
                class="w-4 h-4 text-slate-300 group-hover:text-indigo-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                />
              </svg>
            </a>
          )
        }

        {
          meal.data.salad && (
            <a
              href={`${import.meta.env.BASE_URL}recipes/${meal.data.salad}`}
              class="flex items-center gap-4 p-4 hover:bg-slate-50 transition-colors group"
            >
              <span class="w-20 flex-shrink-0 text-xs font-semibold text-slate-400 uppercase tracking-wider">
                Salad
              </span>
              <span class="flex-1 font-medium text-slate-900 group-hover:text-indigo-600 transition-colors">
                {getRecipeTitle(meal.data.salad)}
              </span>
              <svg
                class="w-4 h-4 text-slate-300 group-hover:text-indigo-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                />
              </svg>
            </a>
          )
        }

        {
          meal.data.sauce && (
            <a
              href={`${import.meta.env.BASE_URL}recipes/${meal.data.sauce}`}
              class="flex items-center gap-4 p-4 hover:bg-slate-50 transition-colors group"
            >
              <span class="w-20 flex-shrink-0 text-xs font-semibold text-slate-400 uppercase tracking-wider">
                Sauce
              </span>
              <span class="flex-1 font-medium text-slate-900 group-hover:text-indigo-600 transition-colors">
                {getRecipeTitle(meal.data.sauce)}
              </span>
              <svg
                class="w-4 h-4 text-slate-300 group-hover:text-indigo-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                />
              </svg>
            </a>
          )
        }

        {
          meal.data.dessert && (
            <a
              href={`${import.meta.env.BASE_URL}recipes/${meal.data.dessert}`}
              class="flex items-center gap-4 p-4 hover:bg-slate-50 transition-colors group"
            >
              <span class="w-20 flex-shrink-0 text-xs font-semibold text-slate-400 uppercase tracking-wider">
                Dessert
              </span>
              <span class="flex-1 font-medium text-slate-900 group-hover:text-indigo-600 transition-colors">
                {getRecipeTitle(meal.data.dessert)}
              </span>
              <svg
                class="w-4 h-4 text-slate-300 group-hover:text-indigo-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                />
              </svg>
            </a>
          )
        }
      </div>
    </section>

    {/* Best For Days */}
    {
      meal.data.bestFor && meal.data.bestFor.length > 0 && (
        <section class="mb-6">
          <h2 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">
            Best For
          </h2>
          <div class="flex flex-wrap gap-2">
            {meal.data.bestFor.map((day) => (
              <span class="inline-flex items-center px-3 py-1.5 bg-indigo-50 text-indigo-700 text-sm font-medium rounded-lg border border-indigo-100">
                {day}
              </span>
            ))}
          </div>
        </section>
      )
    }

    {/* Cuisines */}
    {
      meal.data.cuisines && meal.data.cuisines.length > 0 && (
        <section class="mb-8">
          <h2 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">
            Cuisines
          </h2>
          <div class="flex flex-wrap gap-2">
            {meal.data.cuisines.map((cuisine) => (
              <span class="inline-flex items-center px-3 py-1.5 bg-purple-50 text-purple-700 text-sm font-medium rounded-lg border border-purple-100">
                {cuisine}
              </span>
            ))}
          </div>
        </section>
      )
    }

    {/* Notes from markdown body */}
    <section
      class="bg-white rounded-2xl border border-slate-200/80 shadow-soft p-6 sm:p-8 prose-refined"
    >
      <Content />
    </section>
  </div>
</Layout>
